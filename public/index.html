<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SORICH TABLE WATER SYSTEM</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:linear-gradient(to bottom,#cceeff,#fff); transition:0.5s;}
  header {text-align:center;font-size:26px;font-weight:bold;color:#0066cc;padding:20px;}
  .time {text-align:center;font-size:14px;color:#333;margin-bottom:20px;}
  .container {width:90%;margin:auto;}
  button {margin:5px;padding:10px 15px;font-size:14px;border:none;border-radius:5px;cursor:pointer;transition:0.3s;}
  button:hover {background:#0066cc;color:#fff;}
  .stat-boxes {display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
  .stat-box {flex:1;min-width:120px;background:#f0f8ff;padding:15px;border-radius:8px;text-align:center;font-weight:bold;color:#0066cc;}
  table {width:100%;border-collapse:collapse;margin-bottom:15px;}
  th,td {border:1px solid #0066cc;padding:8px;text-align:center;}
  th {background:#cceeff;}
  input, select {padding:5px;margin:3px;}
  .section {margin-bottom:30px;}
  body.dark-mode {background:#001f3f;color:#fff;}
  body.dark-mode table th, body.dark-mode table td {border-color:#fff;}
  body.dark-mode th {background-color:#003366;}
  .btn-debt {background-color:red;color:#fff;}
  .btn-expense {background-color:yellow;color:#000;}
  .invoice-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:1000;}
  .invoice-content {background:#fff;padding:20px;width:90%;max-width:600px;border-radius:10px;overflow:auto;max-height:90%;}
  .invoice-content table {border:1px solid #000;}
  .invoice-content th, .invoice-content td {border:1px solid #000;padding:5px;}
  .close-btn {float:right;background:red;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;}
</style>
</head>
<body>

<header>SORICH TABLE WATER ‚Äî DRINK IT. LOVE IT</header>
<div class="time" id="liveTime"></div>
<div class="container">

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="section">
    <h2>Login</h2>
    <label>Username: <input type="text" id="username"></label><br>
    <label>Password: <input type="password" id="password"></label><br><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- DASHBOARD ENTRY -->
  <div id="enterDashboardPage" class="section" style="display:none;">
    <h2>Welcome to SORICH TABLE WATER SYSTEM</h2>
    <button onclick="showSection('dashboardPage')">Enter Dashboard</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardPage" class="section" style="display:none;">
    <h2>Main Dashboard</h2>
    <div class="stat-boxes">
      <div class="stat-box">üí∞ Total Sales: ‚Ç¶<span id="totalSales">0</span></div>
      <div class="stat-box">‚úÖ Total Paid: ‚Ç¶<span id="totalPaid">0</span></div>
      <div class="stat-box btn-expense">üí≤ Expenses: ‚Ç¶<span id="expenses">0</span></div>
      <div class="stat-box btn-debt">‚ùå Debts: ‚Ç¶<span id="debts">0</span></div>
      <div class="stat-box">üìà Avg Unit Price: ‚Ç¶<span id="avgUnitPrice">0</span></div>
    </div>
    <div class="dashboard-buttons">
      <button onclick="showSection('salesPage')">üõí Sales</button>
      <button onclick="showSection('debtorsPage')">üí≥ Debtors</button>
      <button onclick="showSection('expensesPage')">üí∞ Expenses</button>
      <button onclick="endOfDay()">üìÖ End of Day</button>
      <button onclick="showSection('dailyRecordsPage')">üìã Daily Records</button>
      <button onclick="showSection('chartsPage')">üìä Charts</button>
      <button onclick="settingsPage()">‚öô Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- SALES PAGE -->
  <div id="salesPage" class="section" style="display:none;">
    <h2>Sales</h2>
    <label>Customer: <input type="text" id="saleCustomer" placeholder="New or select customer" oninput="prefillOwing()"></label>
    <label>Qty: <input type="number" id="saleQty" value="10"></label>
    <label>Total Amount: <input type="number" id="saleTotal" value="2500"></label>
    <label>Amount Paid: <input type="number" id="salePaid" value="2000"></label>
    <p>Unit Price: ‚Ç¶<span id="saleUnitPrice">0</span> | Owing: ‚Ç¶<span id="saleOwing">0</span></p>
    <button onclick="addSale()">Add Sale</button>
    <button onclick="printInvoice()">Print Invoice</button>
    <button onclick="backToDashboard()">Back to Dashboard</button>

    <h4>Live Summary:</h4>
    <p>Total Qty: <span id="sumQty">0</span> | Total Amount: ‚Ç¶<span id="sumTotal">0</span> | Total Paid: ‚Ç¶<span id="sumPaid">0</span> | Total Owing: ‚Ç¶<span id="sumOwing">0</span> | Avg Unit Price: ‚Ç¶<span id="avgPrice">0</span></p>

    <table id="salesTable">
      <tr><th>Customer</th><th>Qty</th><th>Total</th><th>Unit Price</th><th>Paid</th><th>Owing</th><th>üñ®</th></tr>
    </table>
  </div>

  <!-- DEBTORS PAGE -->
  <div id="debtorsPage" class="section" style="display:none;">
    <h2>Debtors</h2>
    <table id="debtorsTable">
      <tr><th>Customer</th><th>Total Owed</th><th>Amount Paid</th><th>Balance</th><th>Status</th><th>Pay Now</th></tr>
    </table>
    <button onclick="backToDashboard()">Back to Dashboard</button>
  </div>

  <!-- EXPENSES PAGE -->
  <div id="expensesPage" class="section" style="display:none;">
    <h2>Expenses & Profit</h2>
    <label>Type: <input type="text" id="expenseType"></label>
    <label>Description: <input type="text" id="expenseDesc"></label>
    <label>Amount: <input type="number" id="expenseAmount"></label>
    <label>Paid To: <input type="text" id="expensePaidTo"></label>
    <button onclick="addExpense()">Add Expense</button>
    <button onclick="clearMonthlyExpenses()">Clear Monthly Expenses</button>
    <button onclick="backToDashboard()">Back to Dashboard</button>

    <h4>Expenses Table:</h4>
    <table id="expensesTable">
      <tr><th>Type</th><th>Description</th><th>Amount</th><th>Paid To</th><th>Date</th></tr>
    </table>
    <p>Total Sales: ‚Ç¶<span id="expenseTotalSales">0</span> | Total Expenses: ‚Ç¶<span id="expenseTotal">0</span> | Profit: ‚Ç¶<span id="expenseProfit">0</span></p>
  </div>

  <!-- DAILY RECORDS PAGE -->
  <div id="dailyRecordsPage" class="section" style="display:none;">
    <h2>Daily Records</h2>
    <table id="dailyTable">
      <tr><th>Date</th><th>Total Sales</th><th>Total Expenses</th><th>Net Balance</th><th>Avg Unit Price</th><th>View</th><th>Clear</th></tr>
    </table>
    <button onclick="backToDashboard()">Back to Dashboard</button>
  </div>

  <!-- CHARTS PAGE -->
  <div id="chartsPage" class="section" style="display:none;">
    <h2>Top Buying Customers</h2>
    <canvas id="chartCanvas" width="400" height="200"></canvas>
    <button onclick="backToDashboard()">Back to Dashboard</button>
  </div>

  <!-- SETTINGS PAGE -->
  <div id="settingsPage" class="section" style="display:none;">
    <h2>Settings</h2>
    <label>Dark Mode: <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"></label><br>
    <label>Background Color: <input type="color" id="bgColorPicker" onchange="updateBgColor()"></label><br>
    <label>Manager Name: <input type="text" id="managerName"></label><br>
    <label>Contact Phone 1: <input type="text" id="contact1"></label><br>
    <label>Invoice Footer: <input type="text" id="invoiceFooter" value="Drink It. Love It."></label><br>
    <label>Default Currency: 
      <select id="currency">
        <option>‚Ç¶</option>
        <option>$</option>
        <option>‚Ç¨</option>
      </select>
    </label><br>
    <label>Invoice Copies: <input type="number" id="invoiceCopies" value="4"></label><br><br>
    <h3>Account Settings</h3>
    <label>Change Username: <input type="text" id="newUsername"></label><br>
    <label>Old Password: <input type="password" id="oldPassword"></label><br>
    <label>New Password: <input type="password" id="newPassword"></label><br>
    <label>Confirm New Password: <input type="password" id="confirmPassword"></label><br>
    <button onclick="changeAccountSettings()">Save Account Settings</button><br><br>
    <button onclick="backToDashboard()">Back to Dashboard</button>
  </div>

</div>

<!-- INVOICE MODAL -->
<div class="invoice-modal" id="invoiceModal">
  <div class="invoice-content" id="invoiceContent">
    <button class="close-btn" onclick="closeInvoiceModal()">X</button>
    <div id="invoiceBody"></div>
    <button onclick="printModalInvoice()">Print</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =======================
// LOGIN DATA
// =======================
let loginCredentials = {username:'admin', password:'admin'};

// =======================
// PERSISTENT DATA
// =======================
let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
let debtData = JSON.parse(localStorage.getItem('debtData')) || [];
let expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
let dailyData = JSON.parse(localStorage.getItem('dailyData')) || [];
let invoiceNumber = parseInt(localStorage.getItem('invoiceNumber')) || 1;
let chartInstance = null;

// =======================
// LIVE TIME
// =======================
function updateTime(){ document.getElementById('liveTime').innerText=new Date().toLocaleString(); }
setInterval(updateTime,1000); updateTime();

// =======================
// LOGIN & NAV
// =======================
function login(){ 
  const u=document.getElementById('username').value; 
  const p=document.getElementById('password').value;
  if(u===loginCredentials.username && p===loginCredentials.password){ showSection('enterDashboardPage'); } 
  else alert('Invalid credentials');
}
function logout(){ location.reload(); }
function showSection(id){
  ['loginPage','enterDashboardPage','dashboardPage','salesPage','debtorsPage','expensesPage','dailyRecordsPage','chartsPage','settingsPage']
  .forEach(s=>document.getElementById(s).style.display='none');
  document.getElementById(id).style.display='block';
  if(id==='chartsPage') renderChart();
  if(id==='debtorsPage') renderDebtors();
}
function backToDashboard(){ showSection('dashboardPage'); }
function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
function updateBgColor(){ document.body.style.background=document.getElementById('bgColorPicker').value; }
function settingsPage(){ showSection('settingsPage'); }

// =======================
// SALES LOGIC
// =======================
const saleQty=document.getElementById('saleQty'), saleTotal=document.getElementById('saleTotal'), salePaid=document.getElementById('salePaid');
function updateSaleCalc(){
  const q=parseFloat(saleQty.value)||0, t=parseFloat(saleTotal.value)||0, p=parseFloat(salePaid.value)||0;
  document.getElementById('saleUnitPrice').innerText=q?(t/q).toFixed(2):0;
  document.getElementById('saleOwing').innerText=(t-p).toFixed(2);
}
[saleQty,saleTotal,salePaid].forEach(e=>e.addEventListener('input',updateSaleCalc)); updateSaleCalc();

function prefillOwing(){
  const name=document.getElementById('saleCustomer').value;
  const debt=debtData.find(d=>d.customer.toLowerCase()===name.toLowerCase());
  if(debt) {
    const total=parseFloat(saleTotal.value)||0;
    salePaid.value = total - debt.owing;
  }
  updateSaleCalc();
}

function addSale(){
  const customer=document.getElementById('saleCustomer').value||'Unknown';
  const qty=parseFloat(saleQty.value)||0, total=parseFloat(saleTotal.value)||0, paid=parseFloat(salePaid.value)||0;
  const unit=qty?(total/qty).toFixed(2):0, owing=(total-paid).toFixed(2);

  salesData.push({customer,qty,total,unit:parseFloat(unit),paid,owing:parseFloat(owing)});

  const debtIndex = debtData.findIndex(d=>d.customer.toLowerCase()===customer.toLowerCase());
  if(debtIndex>=0){
    debtData[debtIndex].owing += parseFloat(owing);
    debtData[debtIndex].totalPaid += paid;
  } else {
    debtData.push({customer, owing:parseFloat(owing), totalPaid:paid});
  }

  renderSalesTable(); renderDebtors();

  document.getElementById('saleCustomer').value=''; saleQty.value=10; saleTotal.value=2500; salePaid.value=2000; updateSaleCalc();

  // SAVE TO LOCALSTORAGE
  localStorage.setItem('salesData', JSON.stringify(salesData));
  localStorage.setItem('debtData', JSON.stringify(debtData));
}

// =======================
// RENDER FUNCTIONS
// =======================
function renderSalesTable(){
  const table=document.getElementById('salesTable');
  table.innerHTML='<tr><th>Customer</th><th>Qty</th><th>Total</th><th>Unit Price</th><th>Paid</th><th>Owing</th><th>üñ®</th></tr>';
  let sumQty=0,sumTotal=0,sumPaid=0,sumOwing=0, unitSum=0;
  salesData.forEach(s=>{
    const row=table.insertRow();
    row.insertCell(0).innerText=s.customer;
    row.insertCell(1).innerText=s.qty;
    row.insertCell(2).innerText=s.total;
    row.insertCell(3).innerText=s.unit;
    row.insertCell(4).innerText=s.paid;
    row.insertCell(5).innerText=s.owing;
    const btn=document.createElement('button'); btn.innerText='Print'; btn.onclick=()=>printInvoice(s); row.insertCell(6).appendChild(btn);

    sumQty+=s.qty; sumTotal+=s.total; sumPaid+=s.paid; sumOwing+=s.owing; unitSum+=s.unit;
  });
  const avgUnit = salesData.length ? (unitSum/salesData.length).toFixed(2) : 0;
  document.getElementById('sumQty').innerText=sumQty;
  document.getElementById('sumTotal').innerText=sumTotal;
  document.getElementById('sumPaid').innerText=sumPaid;
  document.getElementById('sumOwing').innerText=sumOwing;
  document.getElementById('avgPrice').innerText=avgUnit;
  document.getElementById('totalSales').innerText=sumTotal;
  document.getElementById('totalPaid').innerText=sumPaid;

  const totalDebt = debtData.reduce((acc,d)=>acc+d.owing,0);
  document.getElementById('debts').innerText=totalDebt.toFixed(2);
  document.getElementById('avgUnitPrice').innerText=avgUnit;
}

function renderDebtors(){
  const table=document.getElementById('debtorsTable');
  table.innerHTML='<tr><th>Customer</th><th>Total Owed</th><th>Amount Paid</th><th>Balance</th><th>Status</th><th>Pay Now</th></tr>';
  debtData.forEach(d=>{
    const row=table.insertRow();
    row.insertCell(0).innerText=d.customer;
    row.insertCell(1).innerText=(d.totalPaid+d.owing).toFixed(2);
    row.insertCell(2).innerText=d.totalPaid.toFixed(2);
    row.insertCell(3).innerText=d.owing.toFixed(2);
    row.insertCell(4).innerText=d.owing>0?'Owing':'Paid';
    const btn=document.createElement('button'); btn.innerText='Pay';
    btn.onclick=()=>{ 
      let amt=parseFloat(prompt(`Enter amount to pay for ${d.customer}`))||0; 
      d.owing-=amt; d.totalPaid+=amt; 
      renderDebtors(); renderSalesTable(); 
      localStorage.setItem('debtData', JSON.stringify(debtData));
    };
    row.insertCell(5).appendChild(btn);
  });

  const totalDebt = debtData.reduce((acc,d)=>acc+d.owing,0);
  document.getElementById('debts').innerText=totalDebt.toFixed(2);
}

// =======================
// END OF DAY
// =======================
function endOfDay(){
  if(salesData.length===0){ alert('No sales today'); return; }
  const totalSales=salesData.reduce((a,b)=>a+b.total,0);
  const totalExpenses=expenseData.reduce((a,b)=>a+b.amount,0);
  const netBalance=totalSales-totalExpenses;
  const avgUnitPrice=salesData.reduce((a,b)=>a+b.unit*b.qty,0)/salesData.reduce((a,b)=>a+b.qty,0);
  dailyData.push({date:new Date().toLocaleDateString(),sales:[...salesData],totalSales,totalExpenses,netBalance,avgUnitPrice});
  renderDailyRecords();
  alert('End of day completed. Sales moved to daily records.');
  salesData=[]; renderSalesTable();

  // SAVE TO LOCALSTORAGE
  localStorage.setItem('salesData', JSON.stringify(salesData));
  localStorage.setItem('dailyData', JSON.stringify(dailyData));
}

// =======================
// DAILY RECORDS
// =======================
function renderDailyRecords(){
  const table=document.getElementById('dailyTable');
  table.innerHTML='<tr><th>Date</th><th>Total Sales</th><th>Total Expenses</th><th>Net Balance</th><th>Avg Unit Price</th><th>View</th><th>Clear</th></tr>';
  dailyData.forEach((d,i)=>{
    const row=table.insertRow();
    row.insertCell(0).innerText=d.date;
    row.insertCell(1).innerText=d.totalSales;
    row.insertCell(2).innerText=d.totalExpenses;
    row.insertCell(3).innerText=d.netBalance;
    row.insertCell(4).innerText=d.avgUnitPrice.toFixed(2);
    const viewBtn=document.createElement('button'); viewBtn.innerText='View';
    viewBtn.onclick=()=>{ 
      let html=`<h2>Daily Invoice - ${d.date}</h2>`; 
      d.sales.forEach(s=>{ html+=`<p>Customer: ${s.customer} | Qty: ${s.qty} | Unit: ${s.unit} | Total: ${s.total} | Paid: ${s.paid} | Owing: ${s.owing}</p>`; }); 
      showInvoiceModal(html); 
    };
    row.insertCell(5).appendChild(viewBtn);
    const clearBtn=document.createElement('button'); clearBtn.innerText='Clear'; 
    clearBtn.onclick=()=>{ dailyData.splice(i,1); renderDailyRecords(); localStorage.setItem('dailyData', JSON.stringify(dailyData)); };
    row.insertCell(6).appendChild(clearBtn);
  });
}

// =======================
// EXPENSES
// =======================
function addExpense(){
  const type=document.getElementById('expenseType').value;
  const desc=document.getElementById('expenseDesc').value;
  const amount=parseFloat(document.getElementById('expenseAmount').value)||0;
  const paidTo=document.getElementById('expensePaidTo').value;
  if(!type||!desc) return alert('Enter details');
  expenseData.push({type,desc,amount,paidTo,date:new Date().toLocaleDateString()});
  renderExpenses();
  localStorage.setItem('expenseData', JSON.stringify(expenseData));
}

function renderExpenses(){
  const table=document.getElementById('expensesTable'); table.innerHTML='<tr><th>Type</th><th>Description</th><th>Amount</th><th>Paid To</th><th>Date</th></tr>';
  let total=0; expenseData.forEach(e=>{
    const row=table.insertRow(); row.insertCell(0).innerText=e.type; row.insertCell(1).innerText=e.desc;
    row.insertCell(2).innerText=e.amount; row.insertCell(3).innerText=e.paidTo; row.insertCell(4).innerText=e.date; total+=e.amount;
  });
  const totalSales = salesData.reduce((a,b)=>a+b.total,0);
  document.getElementById('expenses').innerText=total;
  document.getElementById('expenseTotalSales').innerText=totalSales;
  document.getElementById('expenseTotal').innerText=total;
  document.getElementById('expenseProfit').innerText=totalSales-total;
}

function clearMonthlyExpenses(){ 
  if(confirm('Clear all monthly expenses?')){
    expenseData=[]; renderExpenses();
    localStorage.setItem('expenseData', JSON.stringify(expenseData));
  } 
}

// =======================
// CHARTS
// =======================
function renderChart(){
  const ctx=document.getElementById('chartCanvas').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  const dataObj=salesData.reduce((acc,s)=>{ acc[s.customer]=(acc[s.customer]||0)+s.total; return acc; },{});
  chartInstance=new Chart(ctx,{type:'bar',data:{labels:Object.keys(dataObj), datasets:[{label:'Total Sales per Customer',data:Object.values(dataObj),backgroundColor:'lightblue'}]}});
}

// =======================
// ACCOUNT SETTINGS
// =======================
function changeAccountSettings(){
  const newU=document.getElementById('newUsername').value;
  const oldP=document.getElementById('oldPassword').value;
  const newP=document.getElementById('newPassword').value;
  const confirmP=document.getElementById('confirmPassword').value;

  if(newP && newP!==confirmP) return alert('New passwords do not match');
  if(oldP && oldP!==loginCredentials.password) return alert('Old password incorrect');
  if(newU) loginCredentials.username=newU;
  if(newP) loginCredentials.password=newP;
  alert('Account settings updated');
  document.getElementById('newUsername').value=''; document.getElementById('oldPassword').value=''; document.getElementById('newPassword').value=''; document.getElementById('confirmPassword').value='';
}

// =======================
// INVOICES
// =======================
function printInvoice(sale){
  const cur=document.getElementById('currency').value||'‚Ç¶';
  const copies=parseInt(document.getElementById('invoiceCopies').value)||4;
  const m=document.getElementById('managerName').value||'Manager';
  const c=document.getElementById('contact1').value||'';
  const f=document.getElementById('invoiceFooter').value||'';
  const items=sale?[sale]:salesData;
  let html='';
  items.forEach(sa=>{
    html += `<h3>SORICH TABLE WATER - Invoice No: STW-${String(invoiceNumber).padStart(6,'0')}</h3>`;
    html += `<p>Customer: ${sa.customer}</p>`;
    html += `<p>Qty: ${sa.qty} | Unit: ${cur}${sa.unit} | Total: ${cur}${sa.total}</p>`;
    html += `<p>Paid: ${cur}${sa.paid} | Owing: ${cur}${sa.owing}</p>`;
    html += `<p>Manager: ${m} | Contact: ${c}</p><p>${f}</p><hr>`;
  });
  invoiceNumber++; localStorage.setItem('invoiceNumber', invoiceNumber);
  showInvoiceModal(html);
}

function showInvoiceModal(html){ document.getElementById('invoiceBody').innerHTML=html; document.getElementById('invoiceModal').style.display='flex'; }
function closeInvoiceModal(){ document.getElementById('invoiceModal').style.display='none'; }
function printModalInvoice(){ const content=document.getElementById('invoiceContent').innerHTML; const w=window.open('','','width=600,height=600'); w.document.write(content); w.document.close(); w.print(); }

// =======================
// INITIAL RENDER
// =======================
renderSalesTable(); renderDebtors(); renderExpenses(); renderDailyRecords();

</script>
</body>
</html>
